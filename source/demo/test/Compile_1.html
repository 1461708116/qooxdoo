<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="de">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15" />
  <title>qooxdoo demo</title>
  <link type="text/css" rel="stylesheet" href="../demolayout.css"/>
  <script type="text/javascript" src="../demoinclude.js"></script>
</head>
<body>
  <script type="text/javascript" src="../demolayout.js"></script>

  <div id="demoDescription">
  </div>

  <textarea id="resultjs" style="position:absolute;width:600px;height:400px;background:white;top:120px;left:20px;border:1px solid black;overflow:auto"></textarea>
  <textarea id="resulthtml" style="position:absolute;width:600px;height:100px;background:white;top:530px;left:20px;border:1px solid black;overflow:auto"></textarea>

  <script type="text/javascript">
    jsout = document.getElementById("resultjs");
    htmlout = document.getElementById("resulthtml");

    var _emptyTags = {
       "IMG":   true,
       "BR":    true,
       "INPUT": true,
       "META":  true,
       "LINK":  true,
       "PARAM": true,
       "HR":    true
    };

    HTMLElement.prototype.__defineGetter__("outerHTML", function () {
       var attrs = this.attributes;
       var str = "<" + this.tagName.toLowerCase();
       for (var i = 0; i < attrs.length; i++)
          str += " " + attrs[i].name + "=\"" + attrs[i].value + "\"";

       if (_emptyTags[this.tagName])
          return str + ">";

       return str + ">" + this.innerHTML + "</" + this.tagName.toLowerCase() + ">";
    });








    window.application.main = function()
    {
      a1 = new QxButton("Hello World", "icons/32/penguin.png");
      a1.setLocation(20, 50);
      this.add(a1);

      a2 = new QxButton("Hello World", "icons/32/appearance.png");
      a2.setLocation(220, 50);
      this.add(a2);
    };

    window.application.post = function()
    {
        var str = "window.application.main = function()\n{\n";




        this.debug("Updating HTML");

        htmlout.value = a1.getElement().outerHTML + a2.getElement().outerHTML;








        this.debug("Serialize...");
        var vBase1 = serializeMain(a1);
        var vBase2 = serializeMain(a2);

        this.debug("Base1: " + vBase1);
        this.debug("Base2: " + vBase2);
        this.debug("Tree Size: " + vObjectCache.length);
        this.debug("Generating Code...");

        for (var i=0, n, v, c, cv, l=vObjectCache.length; i<l; i++)
        {
          v = vObjectCache[i].value;
          c = vObjectCache[i].compiled;

          switch(typeof v)
          {
            case QxConst.TYPEOF_OBJECT:
              if (v == null)
              {
                str += "$" + i + " = null;\n";
              }
              else if (v instanceof QxObject)
              {
                // this.debug("QXOBJECT: " + i + "=" + vObjectCache[i].value);

                if (typeof c == QxConst.TYPEOF_STRING && c.indexOf("$OBJECTMAPPER-") == 0)
                {
                  cv = c.replace("$OBJECTMAPPER-", "");

                  switch(cv)
                  {
                    case "QxClientDocument":
                      str += "$" + i + " = window.application.getClientWindow().getClientDocument();\n";
                      break;

                    case "QxImageManager":
                      str += "$" + i + " = new QxImageManager;\n";
                      break;
                  };
                }
                else
                {
                  str += "var f = new Function();\n";
                  str += "f.prototype = " + v.classname + ".prototype;\n";
                  str += "$" + i + " = new f;\n";
                  str += "QxObjectDataBase[" + v._hashCode + "] = $" + i + ";\n";

                  // constructor call
                  // str += v.classname + ".call($" + i + ");\n";

                  if (v instanceof QxWidget && v.isCreated())
                  {
                    // map elements
                    str += "$" + i + "._valueElement = cssQuery(\"[qxhashcode=" + v._hashCode + "]\")[0];\n";
                    str += "$" + i + "._element = $" + i + "._valueElement;\n";
                    str += "$" + i + "._style = $" + i + "._valueElement.style;\n";

                    // map _QxWidget attribute of node to widget
                    str += "$" + i + "._valueElement._QxWidget = $" + i + ";\n";

                    if (v instanceof QxImage)
                    {
                      // assign _image
                      str += "$" + i + "._image = $" + i + "._valueElement.getElementsByTagName(\"img\")[0];\n";
                    };
                  }
                  else if (v instanceof QxImagePreloader)
                  {
                    str += "$" + i + "._element = new Image;\n";
                    str += "$" + i + "._element.src = \"" + v.getSource() + "\";\n";
                  };
                };
              }
              else if (v instanceof Array)
              {
                // this.debug("JSARRAY: " + i + "=" + vObjectCache[i].value);

                str += "$" + i + " = [];\n";
              }
              else
              {
                // this.debug("JSHASHTABLE: " + i + "=" + vObjectCache[i].value);

                str += "$" + i + " = {};\n";
              };

              break;

            case QxConst.TYPEOF_STRING:
              str += "$" + i + " = \"" + vObjectCache[i].value + "\";\n";
              break;

            case QxConst.TYPEOF_NUMBER:
            case QxConst.TYPEOF_BOOLEAN:
              str += "$" + i + " = " + v + ";\n";
              break;

            case QxConst.TYPEOF_UNDEFINED:
              // this.debug("Undefined value found: " + v);
              str += "$" + i + " = null;\n";
              break;

            case QxConst.TYPEOF_FUNCTION:
              if (typeof c == QxConst.TYPEOF_STRING && c.indexOf("$FUNCTIONMAPPER-") == 0)
              {
                cv = c.replace("$FUNCTIONMAPPER-", "").split("|");
                str += "$" + i + "= QxObjectDataBase[" + cv[1] + "]." + cv[0] + ";\n";
              };
              break;

            default:
              this.debug("Unsupported value: " + v);
              str += "var $" + i + " = \"UNSUPPORTED VALUE\";\n";

          };
        };







        for (var i=0, n, c, v, cv, l=vObjectCache.length; i<l; i++)
        {
          v = vObjectCache[i].value;
          c = vObjectCache[i].compiled;

          if (typeof v == QxConst.TYPEOF_OBJECT && v != null)
          {
            if (v instanceof QxObject)
            {
              if (typeof c == QxConst.TYPEOF_STRING && c.indexOf("$OBJECTMAPPER-") == 0)
              {
                continue;
              };

              for (vKey in vObjectCache[i].compiled)
              {
                if (vObjectCache[i].compiled[vKey] != null)
                {
                  str += "$" + i + "." + vKey + " = $" + vObjectCache[i].compiled[vKey] + ";\n";
                };
              };
            }
            else if (v instanceof Array)
            {
              for (var ia=0, la=vObjectCache[i].compiled.length; ia<la; ia++)
              {
                str += "$" + i + "[" + ia + "] = $" + vObjectCache[i].compiled[ia] + ";\n";
              };
            }
            else
            {
              for (vKey in vObjectCache[i].compiled)
              {
                if (vObjectCache[i].compiled[vKey] != null)
                {
                  str += "$" + i + "[\"" + vKey + "\"] = $" + vObjectCache[i].compiled[vKey] + ";\n";
                };
              };
            };
          };
        };





        str += "};";

        jsout.value = str;

        this.debug("Done");
      };




      var vObjectCache = [];
      var vLastListenerContext = null;

      function serializeMain(vValue)
      {
        var vValue, vIter, vLength;

        // Completly ignore the window and document built-in object
        if (vValue == window || vValue == document) {
          return null;
        };

        // Completly ignore DOM nodes
        if (QxUtil.isValid(vValue) && typeof vValue.nodeType != QxConst.TYPEOF_UNDEFINED) {
          return null;
        };

        for (vIter=0, vLength=vObjectCache.length; vIter<vLength; vIter++)
        {
          if (vObjectCache[vIter].value === vValue)
          {
            return vIter;
          };
        };

        //QxDebug("Serializer", "Known: " + vObjectCache);
        //QxDebug("Serializer", "Serialize: " + vValue + "(" + typeof vValue + ")");

        var vPos = vObjectCache.length;

        vObjectCache[vPos] = { value : vValue };
        vObjectCache[vPos].compiled = serializeWrapper(vValue);

        return vPos;
      };

      function serializeWrapper(vInput)
      {
        switch(typeof vInput)
        {
          case QxConst.TYPEOF_STRING:
          case QxConst.TYPEOF_NUMBER:
          case QxConst.TYPEOF_BOOLEAN:
            return serializeSimple(vInput);

          case QxConst.TYPEOF_OBJECT:
            if (vInput == null)
            {
              return serializeSimple(vInput);
            }
            else if (vInput instanceof Array)
            {
              return serializeArray(vInput);
            }
            else
            {
              return serializeObject(vInput);
            };

          case QxConst.TYPEOF_FUNCTION:
            //QxDebug("Serializer", "FUNCTION: " + vInput);
            return null;
        };

        return null;
      };

      function serializeSimple(vSimple) {
        return vSimple;
      };

      function serializeObject(vObject)
      {
        if (vObject instanceof QxClientDocument) {
          return "$OBJECTMAPPER-QxClientDocument";
        }
        else if (vObject instanceof QxImageManager) {
          return "$OBJECTMAPPER-QxImageManager";
        };

        var vKey;
        var vOut = {};

        for (vKey in vObject)
        {
          // ignore css reference
          switch(vKey)
          {
            case "_style":
              continue;

            case "_listeners":
              // QxDebug("Serializer", "Found Listeners: " + vKey + "::" + vObject);
              vLastListenerContext = vObject;
              break;
          };

          if (typeof vObject[vKey] == QxConst.TYPEOF_FUNCTION)
          {
            if (!(vObject instanceof QxObject) && vLastListenerContext)
            {
              var to = new vLastListenerContext.constructor;
              var tm = null;

              for (vSubKey in to)
              {
                if (to[vSubKey] === vObject[vKey])
                {
                  tm = vSubKey;
                  break;
                };
              };

              if (tm)
              {
                QxDebug("Serializer", "Function Mapped: " + tm);
                var ts = { value : vObject[vKey], compiled : "$FUNCTIONMAPPER-" + tm + "|" + vLastListenerContext._hashCode };
                vObjectCache.push(ts);
                vOut[vKey] = vObjectCache.length-1;
                continue;
              }
              else
              {
                QxDebug("Serializer", "Could not map function: " + vKey + "[" + vLastListenerContext + "]");
              };

              continue;
            }
            else
            {
              continue;
            };
          };

          vOut[vKey] = serializeMain(vObject[vKey]);
        };

        return vOut;
      };

      function serializeArray(vArray)
      {
        var vKey;
        var vOut = [];

        for (var vIter=0, vLength=vArray.length; vIter<vLength; vIter++) {
          vOut.push(serializeMain(vArray[vIter]));
        };

        return vOut;
      };

  </script>
</body>
</html>